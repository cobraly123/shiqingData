<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEO 体检报告</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f9fafb; margin:0; }
    .container { max-width: 1080px; margin: 40px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:16px; }
    .header { display:flex; align-items:center; justify-content:space-between; }
    .title { font-weight:800; font-size:18px; }
    .muted { color:#6b7280; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #e5e7eb; padding:8px; vertical-align:top; }
    th { background:#f3f4f6; color:#374151; }
    .q { color:#111827; word-break:break-word; overflow-wrap:anywhere; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">GEO 品牌体检 · 报告</div>
        <div class="muted" id="status">加载中...</div>
      </div>
      <div id="meta" style="margin-top:8px"></div>
    </div>
    <div class="card" style="margin-top:16px">
      <table id="table">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
  <script>
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id') || '';
    const statusEl = document.getElementById('status');
    const metaEl = document.getElementById('meta');
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    async function load() {
      if (!id) { statusEl.textContent = '缺少任务ID'; return; }
      try {
        async function fetchView() {
          const host = location.hostname;
          const ports = [3011, 3001];
          for (const p of ports) {
            try {
              const r = await fetch(`${location.protocol}//${host}:${p}/api/report/view?id=${encodeURIComponent(id)}`);
              if (r.ok) return await r.json();
            } catch {}
          }
          throw new Error('后端不可达');
        }
        const j = await fetchView();
        statusEl.textContent = j.status === 'completed' ? '已完成' : '进行中';
        const input = j.input || {};
        const providers = j.providers || [];
        const results = j.results || [];
        metaEl.innerHTML = `
          <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px">
            <div><div class="muted">产品/品牌</div><div>${input.product||''}</div></div>
            <div><div class="muted">核心关键词</div><div>${input.seedKeyword||''}</div></div>
            <div><div class="muted">卖点</div><div>${input.sellingPoints||''}</div></div>
            <div><div class="muted">平台</div><div>${providers.join(', ')}</div></div>
          </div>`;
        const head = ['Query', ...providers.map(p => p.toUpperCase())];
        thead.innerHTML = head.map(h => `<th>${h}</th>`).join('');
        const byQ = new Map();
        for (const it of results) {
          const arr = byQ.get(it.query) || [];
          arr.push(it);
          byQ.set(it.query, arr);
        }
        const rows = [];
        for (const [q, arr] of byQ.entries()) {
          const cols = providers.map(p => {
            const it = arr.find(x => x.provider === p);
            return it && it.response ? it.response : '';
          });
          rows.push([q, ...cols]);
        }
        tbody.innerHTML = rows.map(r => `<tr>${r.map((c,i)=> i===0?`<td class="q">${c}</td>`:`<td>${c}</td>`).join('')}</tr>`).join('');
      } catch (e) {
        statusEl.textContent = `加载失败：${String(e)}`;
      }
    }
    load();
  </script>
</body>
</html>
